# Configuration file for the role: percona-server
# These settings may be overwritten by host-level settings


##    !! DO NOT EDIT THIS FILE MANUALLY !!
##    If you do, Ansible will overwrite it


# This configuration is designed for AWS r5ad.2xlarge instances, which means:
# 8 vCPU
# 64G
# 1 x 300 SSD NVMe
#
# The idea is to keep the server as reliable as possible, unless the system crashes.


[client]

host        = localhost
port        = 3306
socket      = {{ mysql_run_dir }}/{{ mysql_socket }}


[mysql]

comments

#skip_symbolic_links = true

max_allowed_packet = 134217728

[mysqld]

## GENERAL
## =======

user        = {{ mysql_user }}

socket      = {{ mysql_run_dir }}/{{ mysql_socket }}
pid_file    = {{ mysql_run_dir }}/{{ mysql_pid }}
port        = 3306

basedir     = {{ mysql_base_dir }}
datadir     = {{ mysql_data_dir }}
tmpdir      = {{ mysql_tmp_dir }}

server_id = {{ mysql_server_id }}

skip-external-locking

plugin_dir = /usr/lib/mysql/plugin
plugin-load-add = server_audit.so;simple_password_check

# SSL
ssl_cert = /etc/ssl/certs/server-cert.pem
ssl_key = /etc/ssl/certs/server-key.pem
ssl_ca = /etc/ssl/certs/ca.pem



# AUDIT

# storage engines
default_storage_engine            = InnoDB
default_tmp_storage_engine        = MEMORY
#internal_tmp_disk_storage_engine  = InnoDB
tmp_table_size                    = 16777216

server_audit=FORCE_PLUS_PERMANENT
server_audit_events                     = {{  server_audit_events }}
server_audit_file_path                  = /var/log/mysql/audit/audit.log
server_audit_file_rotate_size           = {{ audit_file_rotate_size }}
server_audit_logging                    = ON
server_audit_file_rotations             = {{ audit_file_rotations }}
server_audit_excl_users                 =  {{ audit_excl_users }}

# limits
max_allowed_packet = 134217728
max_connections = 300


# caches
table_definition_cache      = 10000
table_open_cache            = 10000
table_open_cache_instances  = 16
thread_cache_size           = 512

# query cache: completely disabled
query_cache_size  = 0
query_cache_type  = 0

userstat = 1

##  STRICTNESS
##  ==========

updatable_views_with_limit = 0
innodb_strict_mode  = 1
innodb_rollback_on_timeout = 1


##  LOGS
##  ====

general_log_file        = {{ mysql_log_dir }}/general/{{ mysql_general_log }}
general_log             = 1

# error log
log_error = {{ mysql_log_dir }}/error/{{ mysql_error_log }}

log_output = FILE

# log queries into a log.slow file
slow_query_log = 1
slow_query_log_file = slow.log

# log all queries
log_throttle_queries_not_using_indexes = 0
long_query_time = 0
min_examined_row_limit = 0
log_queries_not_using_indexes = 1
log_slow_admin_statements = 1
log_slow_slave_statements = 1


##  BINARY LOG
##  ==========

log_bin = 1
log-bin = {{ mysql_log_dir }}/bin/{{ mysql_bin_log }}

# rotation
max_binlog_size   = 1073741824
expire_logs_days  = 7

# format
binlog_format                 = ROW
binlog_row_image              = MINIMAL
binlog_rows_query_log_events  = 0

# reliability vs performance
sync_binlog          = 1
binlog_checksum      = CRC32

# caches
binlog_cache_size       = 32768
binlog_stmt_cache_size  = 32768

# misc
log_slave_updates = 1
log_bin_trust_function_creators = 1


##  MyISAM
##  ======

myisam_recover_options  = BACKUP,FORCE
key_buffer_size         = 4194304


##  InnoDB
##  ======

# buffer pool
innodb_buffer_pool_size        = 50G
innodb_change_buffer_max_size  = 25
innodb_max_dirty_pages_pct     = 90

# buffer pool dump / load
innodb_buffer_pool_load_at_startup   = 1
innodb_buffer_pool_dump_at_shutdown  = 1

# log buffer
innodb_log_files_in_group  = 2
innodb_log_file_size       = 2G
innodb_log_buffer_size     = 16M

# undo log
innodb_undo_logs          = 128
innodb_max_undo_log_size  = 1073741824
innodb_undo_tablespaces   = 0

# flushing
innodb_flush_method             = O_DIRECT
innodb_flush_log_at_trx_commit  = 2

# storage: SSD
innodb_flush_neighbors  = 0
innodb_io_capacity      = 400
innodb_io_capacity_max  = 1000

# checksums
innodb_checksum_algorithm = strict_crc32
innodb_log_checksums      = 1

# concurrency
innodb_autoinc_lock_mode    = 2
innodb_concurrency_tickets  = 5000
innodb_thread_concurrency   = 0
innodb_write_io_threads     = 4
innodb_read_io_threads      = 4

# files
innodb_file_per_table      = 1
innodb_default_row_format  = DYNAMIC

innodb_print_all_deadlocks = 1
innodb_fast_shutdown = 1


##  Timeouts
##  ========

# idle connections
wait_timeout             = 1800
# MDL
lock_wait_timeout        = 30
# InnoDB row locks
innodb_lock_wait_timeout = 30


##  WSREP
##  =====

wsrep_on        = {{ mysql_wsrep_on | default('0') }}
wsrep_provider  = /usr/lib/galera/libgalera_smm.so

# names and addresses

wsrep_cluster_name     = {{ cluster_name }}

wsrep_node_name        = {{ inventory_hostname }}
wsrep_node_address     = {{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}

# paths
wsrep_data_home_dir = /var/lib/mysql

# in case of node/cluster problems
# (partitioning, conflicts, flow control...)
wsrep_dirty_reads       = 0
wsrep_desync            = 0
wsrep_log_conflicts     = 1
wsrep_retry_autocommit  = 3

# vars that affect queries behariour
wsrep_certify_nonPK        = 1
wsrep_convert_LOCK_to_trx  = 0
wsrep_load_data_splitting  = 1

# consistency / performance tradeoff
wsrep_slave_FK_checks  = 0
wsrep_slave_UK_checks  = 0

# writeset size
wsrep_max_ws_rows  = 0
wsrep_max_ws_size  = 2048M

wsrep_provider_options="gcache.size = 1G; gcs.fc_master_slave = YES;"

!include {{ mysql_conf_dir }}/include/wsrep.cnf


[xtrabackup]

user='{{ xtrabackup_mysql_user }}'


[mysqldump]

quick
quote-names
single-transaction

max_allowed_packet = 134217728

!include {{ mysql_conf_dir }}/include/

